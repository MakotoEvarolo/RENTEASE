{% extends 'base/users.html' %}

{% block title %}Rental Detail | RentEase{% endblock %}

{% block content %}
<h2>{{ property.title if property else ('Rental Property #' ~ rental_id) }}</h2>
<img src="/static/images/sample1.jpg" class="img-fluid mb-3 rounded shadow">
<p>{{ property.description if property else 'Description of property…' }}</p>
<p><strong>Price:</strong> {{ property.price if property else '₱10,000/month' }}</p>
<a href="#" class="btn btn-success btn-lg">Rent Now!</a>

{% if session['role'] == 'tenant' and session['user_id'] != landlord.id %}
  <button class="btn btn-primary mt-3" id="messageLandlordBtn">Message Landlord</button>

  <!-- Chat Modal -->
  <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="chatModalLabel">Chat with {{ landlord.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="chatMessages" style="height:250px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-bottom:10px;"></div>
          <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Type your message...">
            <button class="btn btn-primary" id="sendMsgBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const userId = {% if session['user_id'] is defined %}{{ session['user_id']|tojson }}{% else %}null{% endif %};
const landlordId = {% if landlord and landlord.id is defined %}{{ landlord.id|tojson }}{% else %}null{% endif %};
const room = (userId !== null && landlordId !== null) ? `chat_${userId}_${landlordId}` : null;
let socket;

function scrollChatToBottom() {
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
}

{% if session['role'] == 'tenant' and session['user_id'] != landlord.id %}
document.getElementById('messageLandlordBtn').addEventListener('click', function() {
  var chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
  chatModal.show();
  if (!socket && room) {
    socket = io();
    socket.emit('join_room', { room: room });
    socket.on('receive_message', function(data) {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML += `<div><b>${data.sender_id == userId ? 'You' : 'Landlord'}:</b> ${data.content} <span style='font-size:0.8em;color:#888;'>${data.timestamp}</span></div>`;
      scrollChatToBottom();
    });
  }
});
document.getElementById('sendMsgBtn').addEventListener('click', function() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (msg && socket && room) {
    socket.emit('send_message', {
      sender_id: userId,
      receiver_id: landlordId,
      content: msg,
      room: room
    });
    input.value = '';
  }
});
{% endif %}
</script>
{% endblock %}
